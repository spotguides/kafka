pipeline:

  package_zookeeper:
    image: lachlanevenson/k8s-helm:latest
    commands:
      - helm init -c
      - helm package ./.banzaicloud/charts/zookeeper

  deploy_zk:
    image: banzaicloud/ci-pipeline-client:0.10
    action: EnsureDeployment
    deployment:
      name: './zookeeper-1.0.0.tgz'
      releaseName: '{{ .CICD_REPO_NAME }}-zk'

  package_kafka:
    image: lachlanevenson/k8s-helm:latest
    commands:
      - helm init -c
      - helm package ./.banzaicloud/charts/spotguide-kafka

  deploy_kafka:
    image: banzaicloud/ci-pipeline-client:0.10
    action: EnsureDeployment
    deployment:
      name: './spotguide-kafka-1.0.0.tgz'
      releaseName: '{{ .CICD_REPO_NAME }}'
      values:
        historyServer:
          enabled:
        banzaicloud:
          spark:
            image:
              name:
            executor:
              num:
          bucket:
            storageAccountName:
          secret:
            historyServer:
              name: '{{ .CICD_REPO_NAME }}-hs-auth'
        spark:
          monitoring:
            enabled:
            jmxCollector:
            metricsProperties:
          spark-hs:
            sparkEventLogStorage:
              logDirectory:
              cloudProvider:
              secretName: '{{ .CICD_REPO_NAME }}-hs-bucket'
            ingress:
              enabled: true
              annotations:
                kubernetes.io/ingress.class: traefik
                traefik.frontend.rule.type: PathPrefixStrip
                traefik.ingress.kubernetes.io/auth-type: basic
                traefik.ingress.kubernetes.io/auth-secret: '{{ .CICD_REPO_NAME }}-hs-auth'
                ingress.kubernetes.io/ssl-redirect: 'true'
              hosts:
                - 'shs-{{.CICD_REPO_NAME}}-{{.CLUSTER_NAME}}.{{.ORG_NAME}}.{{.DOMAIN_NAME}}'