pipeline:

  package_zookeeper:
    image: lachlanevenson/k8s-helm:latest
    commands:
      - helm init -c
      - helm package ./.banzaicloud/charts/zookeeper

  deploy_zk:
    image: banzaicloud/ci-pipeline-client:0.10
    action: EnsureDeployment
    deployment:
      name: './zookeeper-0.0.1.tgz'
      releaseName: '{{ .CICD_REPO_NAME }}-zk'
      namespace: zookeeper
  
  package_kafka_operator:
    image: lachlanevenson/k8s-helm:latest
    commands:
      - helm init -c
      - helm package ./.banzaicloud/charts/kafka-operator

  deploy_kafka_operator:
    image: banzaicloud/ci-pipeline-client:0.10
    action: EnsureDeployment
    deployment:
      name: './kafka-operator-0.2.0.tgz'
      releaseName: '{{ .CICD_REPO_NAME }}-kafka-operator'
      namespace: kafka

{{{{- if not (eq (.pipeline.deploy_kafka.deployment.values.brokers.ssl.mechanism "none")) }}}}
  install_ssl_secrets:
    image: banzaicloud/ci-pipeline-client:0.10
    action: InstallSecret
    clusterSecret:
      name: '{{ .CICD_REPO_NAME }}-ssl'
      namespace: kafka
      merge: true
  install_sasl_secrets:
    image: banzaicloud/ci-pipeline-client:0.10
    action: InstallSecret
    clusterSecret:
      name: '{{ .CICD_REPO_NAME }}-sasl'
      namespace: kafka
      merge: true
{{{{- end}}}}

  package_kafka:
    image: lachlanevenson/k8s-helm:latest
    commands:
      - helm init -c
      - helm package ./.banzaicloud/charts/spotguide-kafka

  deploy_kafka:
    image: banzaicloud/ci-pipeline-client:0.10
    action: EnsureDeployment
    deployment:
      name: './spotguide-kafka-1.0.1.tgz'
      releaseName: '{{ .CICD_REPO_NAME }}'
      namespace: kafka
{{{{- if not (eq (.pipeline.deploy_kafka.deployment.values.brokers.ssl.mechanism "none")) }}}}
      values:
        brokers:
          ssl:
            secretName: '{{ .CICD_REPO_NAME }}-ssl'
          sasl:
            secretName: '{{ .CICD_REPO_NAME }}-sasl'
{{{{- end}}}}